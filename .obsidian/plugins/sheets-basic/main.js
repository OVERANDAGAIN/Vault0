/* Esbuild-built. Source on GitHub. */
var w=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var C=w((re,q)=>{var y={up:"^",left:"<"},R="m-sheet-cell",K=t=>{t.id=R,t.style.display="none"};q.exports=new class{tableId="m-sheet";isSign=t=>Object.values(y).includes(t);merge=(t,n)=>{if(t.el.id==R)return;let e=1,s;if(t.text==y.left&&t.col>0)s={find:o=>o.row==t.row&&o.col==t.col-e,stop:y.up,type:"colSpan"};else if(t.text==y.up&&t.row>0)s={find:o=>o.row==t.row-e&&o.col==t.col,stop:y.left,type:"rowSpan"};else return;K(t.el);let{find:i,stop:a,type:r}=s,l,u;do{if(l=n.find(i),!l||l.text==a){u=!0;break}e++}while(l.el.id==R);if(u)return;let{el:c}=l;return c[r]||Object.assgin(c,{[r]:1}),c[r]+=1,!0}}});var S=w((oe,A)=>{var{isSign:b}=C();A.exports=t=>new class{constructor(){this.handleSelect(),this.handleFocus()}handleSelect(){let n=t.getClosestCell;t.getClosestCell=function(e,s){let i=this.rows,a=null,r=1/0;for(let c of i){let o=c[0].el.closest("tr");if(!o)continue;let f=o.getBoundingClientRect();if(f.top<=s&&s<=f.bottom){a=c,r=0;break}let d=Math.min(Math.abs(f.top-s),Math.abs(f.bottom-s));d<r&&(a=c,r=d)}let l=null,u=1/0;if(a)for(let c of a){let o=c.el.getBoundingClientRect();if(o.left<=e&&e<=o.right){l=c,u=0;break}let f=Math.min(Math.abs(o.left-e),Math.abs(o.right-e));f<u&&(u=f,l=c)}return l||i[0][0]}}handleFocus(){let n=t.receiveCellFocus;t.receiveCellFocus=function(e,s,i,a){if(t.rows[e]?.[s]?.el.style.display=="none"){let{cell:r}=t.editor.tableCell,l=t.rows.flat(),{row:u,col:c}=l.pop();if(e===r.row){for(;b(t.rows[e]?.[s]?.text);)s+=s<r.col?-1:1;if(s<0)for(;b(t.rows[e]?.[0].text);)e--;s>c&&(s=0,e++,e>u&&t.insertRow(e,s))}else if(s===r.col){for(;b(t.rows[e]?.[s]?.text);)e+=e<r.row?-1:1;if(e<0)for(;b(t.rows[0][s]?.text);)s--}else{if(e===r.row-1)for(;b(t.rows[e][s]?.text);)s--;if(e===r.row+1)for(;b(t.rows[e][s]?.text);)s++}}n.call(this,e,s,i,a)}}}});var I=w((ae,T)=>{var{merge:Q}=C(),Z=S(),k=t=>{let n=t.rows.flat();for(let e of n)Q(e,n);Z(t)},X=t=>t.docView.children.flatMap(n=>n.dom.className.includes("table-widget")?n.widget:[]).map(k);T.exports={mergeTable:k,mergeAllInView:X}});var v=w((ce,P)=>{var x=(t,n)=>t.findIndex(e=>(n?/^\|/:/^(?!\|)/).test(e));P.exports=new class{borderRE=/(?<!\\)\|/;headerRE=/^\s*?(\:)?(?:-+)(\:)?\s*/;trimLeading=t=>t.replace(/^.*?(?=(?<!\\)\|)/,"");rgxFindTable=(t,n)=>{if(n[0].startsWith("```"))return;let e=x(n,!0);if(e===-1)return;n.splice(0,e);let s=x(n),i;for(;s>-1;){let a=n.splice(0,s);if(i=this.buildContGrid(a),!i){let r=x(n,!0);if(r===-1)return;n.splice(0,r),s=x(n);continue}return t.r=n,i}if(s===-1)return this.buildContGrid(n)};buildContGrid=t=>{let n=t.filter(s=>s).map(s=>s.split(this.borderRE).slice(1,-1).map(i=>i.trim())),e=n.findIndex(s=>s.every(i=>this.headerRE.test(i)));if(n[e-1]&&n[e+1])return n.splice(e,1),n}}});var F=w((fe,E)=>{E.exports=class{inlineRefs=[];normalRefs=[];retain=t=>{let n=t.querySelectorAll(".footnote-ref");Array.from(n).map(e=>{let s={cont:e.children[0].dataset.footref,html:e.outerHTML,el:e};e.querySelector(":scope > "+this.inlineAttr)?this.inlineRefs.push(s):this.normalRefs.push(s)})};inlineAttr='[data-footref^="[inline"]';footRE=/(?<!\\)\[\^(.+?)\]/g;dummy=t=>t.replaceAll(this.footRE,"\u21BF$1\u21BF");restore=t=>t.replaceAll(/↿(.+?)↿/g,(n,e)=>{let s=this.normalRefs.find(i=>i.cont===e);return s?s.html:e});handleInline=t=>{let n=t.querySelector("section.footnotes");n&&(n.remove(),t.querySelectorAll(this.inlineAttr).forEach((e,s)=>{e.parentElement.replaceWith(this.inlineRefs[s].el)}))}}});var M=w((he,V)=>{var{tableId:Y,merge:_}=C(),ee=F();V.exports=(t,n)=>class extends n.MarkdownRenderChild{constructor(e,s){super(e);let i=e;i.id=Y,this.domGrid=Array.from(i.rows).map((a,r)=>Array.from(a.cells).map((l,u)=>({el:l,row:r,col:u,text:s[r][u]}))),this.buildDomTable()}onload(){}onunload(){}buildDomTable(){let e=this.domGrid.flat();for(let s of e)_(s,e)||this.normalizeCell(s)}normalizeCell({text:e,el:s}){let i=new ee;e=e.replaceAll("<br>",`
`),e=i.dummy(e),i.retain(s),s.empty(),n.MarkdownRenderer.render(t,e||"\u200B",s,"",this).then(()=>this.afterRender(s,i))}afterRender=(e,s)=>{s.handleInline(e);let i=r=>r.tagName=="P";[e.firstChild,e.lastChild].map(r=>{i(r)&&!r.textContent&&!r.children[0]&&r.remove()});let a="";for(let r of e.childNodes)r.nodeType===3?a+=r.data===`
`?"<br><br>":r.data:a+=i(r)?r.innerHTML:r.outerHTML;a=s.restore(a),e.innerHTML=a}}});var D=w((pe,B)=>{var{trimLeading:G,rgxFindTable:L}=v();B.exports=(t,n)=>{let e=M()(t,n);return postParser=new class{grid=[];main=(s,i)=>{if(s.hasClass("block-language-sheet")||!t.workspace.getActiveFileView())return;let r=Array.from(s.querySelectorAll("table"));if(!r[0])return;let l={};r.map(async(u,c)=>{let o,f=i.getSectionInfo(u);if(f){let{text:d,lineStart:p,lineEnd:h}=f,m;l.t==d&&l.s==p&&l.ed==h?m=l.r:m=d.split(`
`).slice(p,h+1).map(J=>G(J)),l.t=d,l.s=p,l.ed=h,o=L(l,m),this.grid.push(o)}else{await sleep(50);let d=u.offsetParent;if(d?.cmView){let p;if(l.callout===d)p=l.r;else{let h=d.cmView.widget.text;if(!h)return;p=h.split(`
`).map(m=>G(m))}l.callout=d,o=L(l,p)}else o=this.grid[c]}o&&i.addChild(new e(u,o))})}}}});var O=w((H,N)=>{var{buildContGrid:te}=v();N.exports=(t,n)=>{let e=M()(t,n);return async(s,i,a)=>{await n.MarkdownRenderer.render(t,s,i,"",H);let r=i.querySelector("table");if(!r)return;let l=te(s.split(`
`));l&&a.addChild(new e(r,l))}}});var U=w((ge,W)=>{var{mergeTable:j,mergeAllInView:z}=I();W.exports=(t,{ob:n,ViewPlugin:e})=>{let s=new class{get view5(){return t.workspace.getActiveFileView()}get eMode(){return this.view5?.editMode}};class i{update(o){let{eMode:f}=s;if(!f)return;let{tableCell:d}=f;o.transactions.find(m=>m.isUserEvent("undo"))&&d&&(d.table.render(),j(d.table));let{view:h}=o;(o.focusChanged&&h.hasFocus||o.viewportChanged)&&setTimeout(()=>z(h))}}let a=D()(t,n),r=()=>{a.grid=[];let{eMode:c}=s;if(!c)return;let o=c.cm;o&&setTimeout(()=>z(o),50)},l=c=>{let{table:o,cell:f}=c,d=o.rows.flat(),{row:p,col:h,el:m}=f;if(m.rowSpan>1||m.colSpan>1)return d.filter(g=>p<=g.row&&g.row<p+m.rowSpan&&h<=g.col&&g.col<h+m.colSpan).map(g=>{g.el.removeAttribute("id"),g.el.style.display="table-cell"}),m.colSpan=m.rowSpan=1,!0},u=O()(t,n);return function(){this.registerMarkdownPostProcessor(a.main),this.registerMarkdownCodeBlockProcessor("sheet",u),this.registerEvent(t.workspace.on("file-open",r)),t.workspace.onLayoutReady(r),this.addCommand({id:"rebuild",name:"rebuildCurrent",callback:async()=>{a.grid=[];let{view5:c,eMode:o}=s;if(!c)return;let{tableCell:f}=o||{};if(f)l(f)||j(f.table);else{let d=c.getViewType(),p=t.workspace.getLeavesOfType(d).filter(h=>h.view.file?.path==c.file.path);for(let h of p)await h.rebuildView()}},hotkeys:[{modifiers:[],key:"F5"}]}),this.registerEditorExtension([e.fromClass(i)])}}});var $=require("obsidian"),{ViewPlugin:se}=require("@codemirror/view");module.exports=class extends $.Plugin{onload(){U()(this.app,{ob:$,ViewPlugin:se}).call(this)}};
