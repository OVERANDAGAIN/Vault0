[[HOP+迁移至cleanrl]]


# Objectives

* **定位问题根源**：针对 HOP+ 迁移至 CleanRL 框架后无法稳定训练出合作策略的现象，本周的主要目标是通过逐模块排查的方式，明确问题究竟出在 VAE、world model、MOA 模块，还是在整体策略训练逻辑。
* **验证 VAE 表现**：通过对比原始 VAE 与新版 VAE 的 loss 曲线，检验不同 loss 设计（重建项 vs. MOA loss）对模型训练稳定性和表征能力的影响，确认 VAE 是否在信息压缩和动作预测中存在缺陷。
* **评估 world_model 能力**：重点分析 world_model 在状态预测和奖励建模中的精度，观察其是否能为策略提供可靠的前瞻性信息，并判断异常预测（如 agent “跳动”）是否会干扰训练。
* **检查 MOA 模块训练效果**：通过混淆矩阵、动作分布和召回率指标，评估 MOA 在多类动作上的预测性能，分析是否由于离线数据分布偏差或 buffer 逻辑设计，导致模型在自博弈训练中失效。
* **建立 baseline 对照**：结合 PPO baseline 与 HOP+（含 MCTS/不含 MCTS）实验结果，形成性能对比，进一步缩小问题来源，为后续改进提供明确方向。





## Problem1: VAE
- [?] 

### 原来的VAE: loss图: 总体loss很低
4p5b8\*8 
```terminal
D:\BaiduNetdiskDownload\msh-records\4p5b8_8\vae\exp20250401_203634p\dim16
```
![[myplot_4p_16dim.png]]

### moa-VAE：loss图： loss比较大
4p5b8\*8
```
D:\cleanrl\cleanRL\vae_ckpts\vae__1758371809\dim16
```

![[vae_loss_curve.png]]


### moa情况
总体保持稳定，也就是moa预测0.6左右

#### 混淆矩阵：对角线越深越好
![[moa_eval_epoch9_confusion_matrix.png]]

#### 召回率：整体动作准确率

$$
\text{Recall}_i = \frac{\text{预测正确为 i 的样本数}}{\text{真实标签为 i 的总样本数}}
$$

也就是：在所有 **真实为某类** 的样本里，模型有多少被成功识别出来。

![[moa_eval_epoch9_per_class_recall.png]]



## Problem：World_model
- [?] 

![[Pasted image 20250921015931.png]]

在上面这张图的例子中，world_model预测的agent一下子走了两个，并且取得了0.042的奖励。
>不符合物理规律 —————— 联想到：对比学习促进强化学习的那篇文章。

world_model总体预测的还是大体上位置正确，但是做不到非常精准.




- [?] 看一下具体channel 中具体的值是多少，而不是直接四舍五入




---


### 一、通道分布对比

#### 图含义：

每个 “chX dist” 子图展示一个通道（例如 ch0-ch6，对应玩家/障碍/鹿/兔等通道）在真值（true）与预测（pred）下的像素值分布直方图。

蓝色：**真实** 观测值分布（true）
橙色：world model **预测** 分布（pred）

![[calibration_hist.png|1375]]

---

### 二、像素级散点图
####  图含义：
**横轴是真实**像素值（true），**纵轴是预测**像素值（pred）。
黑色虚线：**理想预测线**（y = x）。


![[calibration_scatter.png]]

#### 看到的现象：
* 两条主要的竖线分布：
  * 左侧在 true≈0 附近：绝大多数背景像素；
  * 右侧在 true≈1 附近：物体像素（例如玩家或猎物位置）。
* 在 true=0 时，大部分预测值在 0~0.1 之间，但存在少量 0.3~0.5 的“假阳性”；
* 在 true=1 时，预测值集中在 0.8~1.0 区间，少量点掉落到 0.5 以下。

#### 总结：
> 模型输出在统计意义上是**有校准性的（分布正确）**，
> 但个体像素存在一定的过度平滑。


---

### 三、可视化对比


![[triplet_soft_015.png]]

### **Sample #15**

> `self_a=0 | opp_as=[4,3,6] | true_rew=5.000 | pred_rew=5.012`

**现象：**

* 预测帧 `pred_obs_{t+1}` 中，蓝色五边形（其他玩家）位置基本准确；
* 鹿（黄色星形）被成功预测为消失；
* 误差热力图仅在左中部有轻微亮斑；
* 奖励预测几乎完美（5.012 ≈ 5.000）。


---


![[triplet_soft_026.png]]


### **Sample #26**

> `self_a=4 | opp_as=[4,4,4] | true_rew=0.000 | pred_rew=0.007`

**现象：**

* 模型预测奖励几乎为零（无捕猎）。


* 右图里那些“虚化/半透明”的形状，本质上是 **world_model 的连续输出（0~1 概率/强度）不够接近 1**——通常出现在**多模态/不确定**的地方（它拿不准下一个精确格子），或被 MSE 类损失“平均化”。
* 如果你 **用固定阈值 0.5 二值化**（<0.5→0），就会把这些“半可信”的像素直接抹掉——于是出现你在图三看到的现象：**有些 agent/物体“消失”**。

```ad-seealso
![[Pasted image 20251020153547.png]]

* **现象**：像 sample#4 那张，预测里某 agent 像是“走了两步”。
* **原因**：

  * 多个相邻格子都有中等强度（0.3~0.6），可视化时像“拖影”；
  * 如果后处理取 **argmax**，在噪声/模糊中可能选到了“更远的一个峰”，看起来像“跨格”；
```


---


![[triplet_soft_027.png]]


### **Sample #27**

> `self_a=2 | opp_as=[4,1,0] | true_rew=5.000 | pred_rew=4.968`

**现象：**

* 鹿在预测中正确消失；
* 但左下方一名蓝色五边形位置略有漂移；
* 误差热力图仅在猎物消失区域和玩家交互区亮起；
* 奖励预测依然准确（4.968 ≈ 5.000）。




### 2_Answers


![[Pasted image 20251020153911.png]]![[Pasted image 20251020153959.png]]


![[Pasted image 20251020154114.png]]





---







# Limitations
# Future Work
# FootNotes