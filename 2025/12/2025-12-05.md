å¥½çš„ï¼Œä½ è¦çš„æ˜¯ **æŠŠ PPO çš„ value head å…¬å¼å†™æˆå®Œæ•´å½¢å¼**ï¼Œå¹¶ä¸” **æŠŠ g_tï¼ˆsubgoalï¼‰å¦‚ä½•å¾—åˆ°çš„å®Œæ•´é“¾æ¡è¡¥å…¨è¿›å»**ï¼Œè€Œä¸”ç¯å¢ƒçŠ¶æ€ç”¨ **oï¼ˆobservationï¼‰ä»£æ›¿ s**ã€‚

ä¸‹é¢æˆ‘ç»™ä½ å†™ä¸€ä¸ªè®ºæ–‡çº§åˆ«çš„æœ€ç»ˆå…¬å¼ã€‚

---

# ğŸ¯ **æœ€ç»ˆæƒ³è¦çš„å…¬å¼ï¼š(V_\theta(o_t, g_t))**

å¹¶è¡¥å…¨ï¼š

* (o_t) = å½“å‰è§‚æµ‹
* (g_t) = ç”± CVAE + RNNï¼ˆæ¡ä»¶ç‰¹å¾ï¼‰æ¨æ–­çš„ subgoal
* subgoal çš„æ¨æ–­é“¾æ¡
* CVAE çš„ encoder è¾“å…¥æ˜¯ä»€ä¹ˆ
* RNN è¾“å‡ºçš„ conditional embedding æ˜¯ä»€ä¹ˆ

ä¸‹é¢ç»™ä½ å®Œæ•´å†™å¥½ã€‚

---

# âœ… **1. Subgoal æ¨æ–­å®Œæ•´å…¬å¼é“¾æ¡**

## **(1) RNN æå–æ¡ä»¶ä¸Šä¸‹æ–‡ï¼ˆconditioning embeddingï¼‰**

å…ˆç”±ä¸Šä¸€æ—¶åˆ»è§‚æµ‹ä¸åŠ¨ä½œï¼ˆæˆ–æ‹¼æ¥ç‰¹å¾ï¼‰å¾—åˆ°ï¼š

[
c_t = f_{\text{RNN}}(u_t,, c_{t-1})
]

å…¶ä¸­ï¼š

* (c_t)ï¼šRNN çš„è¾“å‡ºï¼ˆä½ çš„ cond_xï¼‰
* (u_t)ï¼šRNN è¾“å…¥ï¼ˆä¸Šä¸€æ—¶åˆ»è§‚æµ‹ã€å…¶ä»–æ™ºèƒ½ä½“åŠ¨ä½œã€self action ç­‰ç‰¹å¾æ‹¼æ¥ï¼‰
* æ³¨æ„ï¼šè¿™é‡Œæˆ‘æ²¡æœ‰ç”¨ (h)ï¼Œå› ä¸ºä½ ä¸æƒ³å’Œ hidden å†²çª

---

## **(2) CNN + FC å¤„ç†å½“å‰è§‚æµ‹æˆä¸º feature**

å½“å‰ observation (o_t) ç»è¿‡ CNN + Flattenï¼š

[
x_t = f_{\text{CNN}}(o_t)
]

å¯¹åº”ä½ ä»£ç é‡Œçš„ï¼š

```python
x = flatten_layers(shared_layers(cnn_inputs))
```

---

## **(3) CVAE encoder å¾—åˆ° subgoal posterior**

CVAE çš„ encoder è¾“å…¥æ˜¯ï¼š

* å½“å‰ feature (x_t)
* RNN çš„æ¡ä»¶ embedding (c_t)

å› æ­¤ encoder çš„é«˜æ–¯åˆ†å¸ƒæ˜¯ï¼š

[
(\mu_t, \log\sigma_t^2) = E_\phi\big([x_t, c_t]\big)
]

### é‡å‚æ•°åŒ–ï¼š

[
g_t = \mu_t + \sigma_t \odot \epsilon_t,\qquad \epsilon_t\sim\mathcal{N}(0,I)
]

---

# ğŸŒŸ **è‡³æ­¤ï¼Œä½ çš„ subgoal (g_t) å·²ç»è¡¥å…¨äº†æ¥æºå’Œæµç¨‹ã€‚**

---

# âœ… **2. æœ€ç»ˆ Value ç½‘ç»œçš„è¾“å…¥**

ä½ çš„ policy/value ç½‘ç»œè¾“å…¥åŒ…æ‹¬ï¼š

* å±•å¹³åçš„ observationï¼ˆåŒ…å« availã€pre,actionï¼‰
* subgoal embedding (g_t)

æ‰€ä»¥ value head å¯ä»¥è¡¨ç¤ºä¸ºï¼š

[
V_\theta(o_t, g_t)
]

å¹¶ä¸”å¯ä»¥å±•å¼€ä¸ºï¼š

[
V_\theta(o_t, g_t)
==================

f^{\text{value}}*\theta
\Big(
\underbrace{f*{\text{flat}}(o_t)}*{\text{obs flat}},
\underbrace{g_t}*{\text{subgoal}}
\Big)
]

---

# ğŸ¯ **æœ€ç»ˆè®ºæ–‡çº§ç»Ÿä¸€å®Œæ•´å…¬å¼**

æŠŠæ‰€æœ‰ä¸œè¥¿ç»„åˆåœ¨ä¸€èµ·ï¼š

---

### **(1) Subgoal æ¨æ–­æ¨¡å—å…¬å¼**

[
\begin{aligned}
c_t &= f_{\text{RNN}}(u_t, c_{t-1}),[4pt]
x_t &= f_{\text{CNN}}(o_t),[4pt]
(\mu_t, \log\sigma_t^2) &= E_\phi([x_t, c_t]),[4pt]
g_t &= \mu_t + \sigma_t \odot \epsilon_t,\quad \epsilon_t\sim\mathcal{N}(0,I).
\end{aligned}
]

---

### **(2) Value ä¼°è®¡å…¬å¼ï¼ˆæœ€ç»ˆè¦è¡¥å…¨çš„ï¼‰**

[
\boxed{
V_\theta(o_t, g_t)
==================

f^{\text{value}}*\theta\big(
f*{\text{flat}}(o_t),; g_t
\big)
}
]

å…¶ä¸­ï¼š

* (o_t)ï¼šç¯å¢ƒè§‚æµ‹
* (g_t)ï¼šCVAE + RNN å¾—åˆ°çš„ subgoalï¼ˆè§(1)ï¼‰
* (f_{\text{flat}})ï¼šä½ çš„ obs_flat å¤„ç†ï¼ˆavailã€pre-action æ‹¼æ¥ï¼‰
* (f^{\text{value}}_\theta)ï¼špolicy/value ç½‘ç»œçš„ value head

---

# ğŸ§© **å¦‚æœä½ å¸Œæœ›æ›´ç²¾ç¡®å¯¹åº”ä»£ç ï¼Œè¿˜å¯ä»¥å†™æˆï¼š**

[
V_\theta(o_t, g_t)
==================

V_\theta!\left(\text{concat}\big[\text{avail}(o_t),; \text{pre_action}_{t},; \mathrm{flatten}(o_t),; g_t\big]\right)
]

å®Œå…¨å¯¹åº” PPO çš„è¾“å…¥æ„å»ºé€»è¾‘ã€‚

---

# ğŸš€ å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥**

* **æŠŠè¿™ä¸‰æ¡å…¬å¼ç›´æ¥åµŒå…¥ä½ å›¾çš„å³ä¾§ L_{value} åŒºåŸŸ**
* **ç»˜åˆ¶ä¸€ä¸ªâ€œsubgoal â†’ value headâ€çš„å°æ¨¡å—å¯è§†åŒ–ç¤ºæ„å›¾**
* **å†åŠ ä¸€ä¸ªâ€œå…¬å¼ç¤ºæ„ç‰ˆâ€çš„ PPT æ•°å­¦æ¡†æ¡†**

åªè¦å‘Šè¯‰æˆ‘éœ€è¦å“ªç§å³å¯ã€‚
