好，那咱就**严格按照这段 PPO 代码**，把图里这块
$$V_\theta(o_t, g_t),; L_{\text{value}},; \hat R_t$$
都用公式写清楚（以后你在图下/方法里就直接照抄这些）。

---

## 1. 先约定记号（跟代码一一对应）

对某个 agent（例如第 $i$ 个），在一条轨迹上的第 $t$ 步：

* 观测：$o_t$（代码里是 `obs_flat` 等）
* subgoal/latent：$g_t$（代码中暂时是全 $0$ 的 `subgoal`，但接口保留）
* 奖励：$r_t$（`rewards[b,t]`）
* 终止标志：$d_t$（`term[b,t]`，终止为 $1$）
* 价值估计：
  $$V_t = V_\theta(o_t, g_t)$$
  对应代码里的 `V = values_new` 或 `values`

折扣系数 $\gamma$ 和 GAE 系数 $\lambda$ 分别对应 `gamma` 与 `gae_lambda`。

---

## 2. GAE 里的 $\hat R_t$（代码中的 `ret[b,t]`）

代码片段：

```python
V = values_new
Vn[:, :-1] = V[:, 1:]
Vn[:, -1] = 0.0

delta = rewards + gamma * (1 - term) * Vn - V
gae = delta + gamma * lam * (1 - term) * gae
ret = gae + V
```

数学形式就是标准 GAE：

1. TD 残差（对应 `delta`）
   $$\delta_t = r_t + \gamma (1-d_t) V_{t+1} - V_t$$

2. GAE 优势（对应 `adv[b,t]` 和中间的 `gae`）
   $$\hat A_t = \delta_t + \gamma\lambda(1-d_t)\hat A_{t+1}$$

3. 价值目标（代码里的 `ret[b,t]`，也就是你图中想写的 $\hat R_t$）：
   $$\boxed{\hat R_t = \hat A_t + V_t}$$

这一行可以直接写在图下：“GAE-based value target”。

---

## 3. Value loss：$L_{\text{value}}$（带 clipping）

代码：

```python
v_clipped = old_val + (values - old_val).clamp(-clip_eps, clip_eps)
v_loss1 = (values - ret_flat) ** 2
v_loss2 = (v_clipped - ret_flat) ** 2
v_loss = mean( max(v_loss1, v_loss2) )
```

把 batch/遮罩略去，只看单个 $(o_t,g_t)$ 的形式，就是 PPO 里的“Clipped Value Loss”：

* 旧价值：$V_t^{\text{old}}$（`old_val`）

* 新价值：$V_t = V_\theta(o_t,g_t)$（`values`）

* 裁剪后的价值：
  $$V_t^{\text{clip}} = V_t^{\text{old}} + \mathrm{clip}!\left(V_t - V_t^{\text{old}},; -\epsilon,; \epsilon\right)$$
  其中 $\epsilon$ 就是 `clip_eps`。

* 单步 value loss：
  $$\ell_{\text{value}}(t)
  = \max\Big[(V_t - \hat R_t)^2,; (V_t^{\text{clip}} - \hat R_t)^2\Big]$$

* 整体：
  $$\boxed{
  L_{\text{value}}
  = \mathbb{E}*t\big[\ell*{\text{value}}(t)\big]
  }$$

这就和你图里的 $L_{\text{value}}$ 完全对上了。

---

## 4. 图里可以怎么排（建议写法）

你那块 value 模块旁边/下方，可以写成这样三行（最精简又严谨）：

* 价值估计：
  $$V_t = V_\theta(o_t, g_t)$$

* GAE 目标：
  $$\delta_t = r_t + \gamma (1-d_t) V_{t+1} - V_t$$
  $$\hat A_t = \delta_t + \gamma\lambda (1-d_t) \hat A_{t+1}$$
  $$\hat R_t = \hat A_t + V_t$$

* Clipped value loss：
  $$V_t^{\text{clip}}
  = V_t^{\text{old}} +
  \mathrm{clip}\left(V_t - V_t^{\text{old}}, -\epsilon, \epsilon\right)$$
  $$L_{\text{value}}
  = \mathbb{E}_t\Big[
  \max\big(
  (V_t - \hat R_t)^2,
  (V_t^{\text{clip}} - \hat R_t)^2
  \big)
  \Big]$$

你图里的那几个圆圈 $(o_{t-1}, r_{t-1}, o_t, r_t)$ 就负责“说明 $\hat R_t$ 是从整段轨迹里算出来的”，
下面的蓝色框写 $V_\theta(o_t,g_t)$ 和 $L_{\text{value}}$，再在图注里放上面这组公式，就很完整了。
