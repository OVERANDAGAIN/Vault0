---
创建时间: 2025-九月-20日  星期六, 9:07:06 晚上
---
[[HOP+迁移至cleanrl]]


# Objectives
# Results
# Insights
# Setup
# Methodology
# Issues & Debugging

## Problem1: VAE的loss有点大
- [?] 

### 原来的VAE: loss图: 总体loss很低
4p5b8\*8 
```terminal
D:\BaiduNetdiskDownload\msh-records\4p5b8_8\vae\exp20250401_203634p\dim16
```
![[myplot_4p_16dim.png]]

### 新版VAE：loss图： loss比较大
可以看到，`total_loss` 在1.6左右，远不如上面的接近0的loss表现

4p5b8\*8
```
D:\cleanrl\cleanRL\vae_ckpts\vae__1758371809\dim16
```

![[vae_loss_curve.png]]

### Answer：因为VAE-loss去掉了重建项，加上了moa-loss项
D:\cleanrl\cleanRL\pretrain_vae.py
```python

    def train(self, states, actions, times):
        recons_loss, kld_loss, loss, z = self.am_model.loss_func(states)
        predict_action_dist = self.policy_model(states, times, z)


        # 计算 policy_loss: MSE between predicted action and true action

        policy_loss = nn.CrossEntropyLoss()(predict_action_dist, actions.long())
        total_loss = policy_loss + self.args['omg_vae_alpha'] * kld_loss
        # total_loss = recons_loss + self.args['omg_vae_alpha'] * kld_loss
        self.optimiser.zero_grad()
        total_loss.backward()
        grad_norm = torch.nn.utils.clip_grad_norm_(self.params, self.args['omg_config']['grad_norm_clip'])
        self.optimiser.step()
        return policy_loss, kld_loss, total_loss
```



当改为：

```
        # total_loss = policy_loss + self.args['omg_vae_alpha'] * kld_loss
        total_loss = recons_loss + self.args['omg_vae_alpha'] * kld_loss
```

D:\cleanrl\cleanRL\vae_ckpts\vae__1758373486\dim16
![[vae_loss_curve 1.png]]
loss图就变得很小了

### 总结：不是数据或者代码的问题，是loss设计的不同导致的
moa的预测动作部分的loss 相比较下来就很大，所以说会呈现出这样的不同
>之前用moa_loss替换掉recons_loss的原因就是recons_loss随着训练过程就是会降到很低，所以想到不用这个，而是用moa_loss。

### dlc:moa情况
总体保持稳定，也就是moa预测0.6左右
>但是有个问题，预测的动作中，很大一部分是4，也就是静止，而对于捕猎的动作（5,6）在数据中的占比不大
>但是：也不能这么比，因为离线数据汇总就是混杂这NS和NH的不同策略

```
D:\anaconda\envs\hopplus\python.exe D:\cleanrl\cleanRL\pretrain_vae.py 
[VAE] Loaded 107010 samples.
[VAE] Begin offline training...

[Epoch 1/10]
[MOA] epoch 0: top1=0.5337, top3=0.7465, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch0.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch0.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 2/10]
[MOA] epoch 1: top1=0.5474, top3=0.7430, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch1.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch1.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 3/10]
[MOA] epoch 2: top1=0.5608, top3=0.7441, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch2.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch2.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 4/10]
[MOA] epoch 3: top1=0.5724, top3=0.7431, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch3.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch3.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 5/10]
[MOA] epoch 4: top1=0.5853, top3=0.7421, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch4.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch4.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 6/10]
[MOA] epoch 5: top1=0.5936, top3=0.7421, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch5.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch5.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 7/10]
[MOA] epoch 6: top1=0.5983, top3=0.7424, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch6.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch6.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 8/10]
[MOA] epoch 7: top1=0.6080, top3=0.7411, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch7.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch7.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 9/10]
[MOA] epoch 8: top1=0.6120, top3=0.7412, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch8.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch8.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16

[Epoch 10/10]
[MOA] epoch 9: top1=0.6152, top3=0.7405, saved:
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch9.csv
       ./vae_ckpts/vae__1758375079\dim16\moa_eval_epoch9.npz
[VAE] 模型保存至: ./vae_ckpts/vae__1758375079\dim16
```


数据在： D:\cleanrl\cleanRL\vae_ckpts\vae__1758375079\dim16



## Problem：World_model
- [?] 

![[Pasted image 20250921015931.png]]

在上面这张图的例子中，world_model预测的agent一下子走了两个，并且取得了0.042的奖励。
>不符合物理规律 —————— 联想到：对比学习促进强化学习的那篇文章。

world_model总体预测的还是大体上位置正确，但是做不到非常精准

```
D:\anaconda\envs\hopplus\python.exe D:\cleanrl\cleanRL\test_obs_reward_model.py 
[INFO] loaded model. obs_shape=(4, 4, 7), action_dim=7
[INFO] dataset size=50000, inferred n_agents=4

=== Metrics ===
Obs  MSE (mean over B,C,H,W): 0.007402
Obs  PSNR: 24.08 dB
Rew  MSE:  0.001189
Per-channel MSE:
  ch[0]: 6.775978e-03
  ch[1]: 1.623118e-02
  ch[2]: 1.559676e-02
  ch[3]: 8.610861e-03
  ch[4]: 4.749758e-08
  ch[5]: 7.902491e-04
  ch[6]: 3.805568e-03

进程已结束，退出代码为 0
```



### 1_Answers



### 2_Answers



# Limitations
# Future Work
# FootNotes